<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>データ整合性チェック - 不動産ポータル管理画面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            color: #2c2c2c;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* ヘッダー */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #2c2c2c;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* メインコンテンツ */
        .main-content {
            flex: 1;
            margin-top: 60px;
            padding: 30px;
            overflow-y: auto;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .breadcrumb {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-size: 14px;
            color: #6a6a6a;
        }

        .breadcrumb a {
            color: #6a6a6a;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 600;
            color: #2c2c2c;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #4a4a4a;
            color: white;
        }

        .btn-primary:hover {
            background: #3a3a3a;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #777777;
            color: white;
        }

        .btn-danger:hover {
            background: #666666;
        }

        .btn-warning {
            background: #888888;
            color: white;
        }

        .btn-warning:hover {
            background: #777777;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* アラート */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-danger {
            background: #f0f0f0;
            border-left: 4px solid #999999;
            color: #333333;
        }

        .alert-warning {
            background: #f5f5f5;
            border-left: 4px solid #777777;
            color: #444444;
        }

        .alert-success {
            background: #f8f8f8;
            border-left: 4px solid #666666;
            color: #222222;
        }

        /* チェック実行パネル */
        .check-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .check-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 20px;
        }

        .check-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .check-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .check-option:hover {
            background: #f8f8f8;
            border-color: #4a4a4a;
        }

        .check-option input[type="checkbox"] {
            margin: 0;
            scale: 1.2;
        }

        .check-option-content {
            flex: 1;
        }

        .check-option-title {
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 5px;
        }

        .check-option-desc {
            font-size: 12px;
            color: #7a7a7a;
            line-height: 1.3;
        }

        .check-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .check-info {
            font-size: 12px;
            color: #666666;
        }

        /* 統計カード */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #4a4a4a;
            margin-bottom: 5px;
        }

        .stat-number.error {
            color: #666666;
        }

        .stat-number.warning {
            color: #777777;
        }

        .stat-number.success {
            color: #555555;
        }

        .stat-label {
            color: #7a7a7a;
            font-size: 14px;
        }

        /* データテーブル */
        .data-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .table-header {
            padding: 20px 25px;
            background: #f5f5f5;
            border-bottom: 1px solid #d0d0d0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #4a4a4a;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            background: #f5f5f5;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #4a4a4a;
            border-bottom: 2px solid #d0d0d0;
            font-size: 13px;
        }

        tbody td {
            padding: 15px;
            border-bottom: 1px solid #e8e8e8;
            font-size: 14px;
            vertical-align: middle;
        }

        tbody tr:hover {
            background: #f9f9f9;
        }

        tbody tr.error {
            background: #fff5f5;
            border-left: 4px solid #999999;
        }

        tbody tr.warning {
            background: #fafafa;
            border-left: 4px solid #777777;
        }

        /* 重要度バッジ */
        .severity-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
            text-align: center;
            min-width: 80px;
        }

        .severity-critical {
            background: #f5f5f5;
            color: #999999;
        }

        .severity-high {
            background: #eeeeee;
            color: #555555;
        }

        .severity-medium {
            background: #f0f0f0;
            color: #6a6a6a;
        }

        .severity-low {
            background: #f8f8f8;
            color: #7a7a7a;
        }

        /* 問題カテゴリバッジ */
        .category-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .category-status {
            background: #e8e8e8;
            color: #333333;
        }

        .category-amount {
            background: #e0e0e0;
            color: #444444;
        }

        .category-approval {
            background: #d8d8d8;
            color: #222222;
        }

        .category-document {
            background: #f0f0f0;
            color: #555555;
        }

        /* 詳細説明 */
        .issue-description {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
            color: #666666;
        }

        /* 進捗バー */
        .progress-container {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-weight: 600;
            color: #4a4a4a;
        }

        .progress-status {
            font-size: 14px;
            color: #666666;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #666666 0%, #444444 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            transition: width 0.3s ease;
        }

        /* タブ */
        .tab-container {
            margin-bottom: 20px;
        }

        .tab-nav {
            display: flex;
            background: white;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666666;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            background: white;
            color: #2c2c2c;
            border-bottom-color: #4a4a4a;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* アクションボタン */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* 実行ログ */
        .log-container {
            background: #1a1a1a;
            color: #f0f0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-line {
            margin-bottom: 3px;
            line-height: 1.4;
        }

        .log-timestamp {
            color: #888888;
        }

        .log-info {
            color: #aaaaaa;
        }

        .log-warning {
            color: #cccccc;
        }

        .log-error {
            color: #ffffff;
            font-weight: bold;
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 95%;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: #2c2c2c;
            color: white;
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #d0d0d0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a4a4a;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #c0c0c0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="header">
            <h1 style="cursor: pointer;" onclick="window.location.href='index.html'">不動産ポータル管理システム</h1>
            <div class="user-info">
                <span>田中 太郎さん</span>
                <button class="btn btn-secondary">ログアウト</button>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="main-content">
            <div class="breadcrumb">
                <a href="index.html">ホーム</a> > 
                <a href="exception_approval_rejection.html">例外処理管理</a> > 
                データ整合性チェック
            </div>

            <div class="page-header">
                <h2 class="page-title">🔍 データ整合性チェック</h2>
                <button class="btn btn-primary" onclick="scheduleAutomaticCheck()">
                    ⏰ 自動チェック設定
                </button>
            </div>

            <!-- チェック実行パネル -->
            <div class="check-panel">
                <h3 class="check-title">整合性チェック実行</h3>
                
                <div class="check-options">
                    <div class="check-option">
                        <input type="checkbox" id="statusConsistency" checked>
                        <div class="check-option-content">
                            <div class="check-option-title">ステータス整合性</div>
                            <div class="check-option-desc">
                                送客ステータスと最新承認ステータスの不整合をチェック
                            </div>
                        </div>
                    </div>

                    <div class="check-option">
                        <input type="checkbox" id="approvalConsistency" checked>
                        <div class="check-option-content">
                            <div class="check-option-title">承認データ整合性</div>
                            <div class="check-option-desc">
                                承認テーブル間のデータ不整合と孤立レコードをチェック
                            </div>
                        </div>
                    </div>

                    <div class="check-option">
                        <input type="checkbox" id="amountValidation" checked>
                        <div class="check-option-content">
                            <div class="check-option-title">金額データ妥当性</div>
                            <div class="check-option-desc">
                                契約金額の未入力、異常値、不整合をチェック
                            </div>
                        </div>
                    </div>

                    <div class="check-option">
                        <input type="checkbox" id="documentIntegrity">
                        <div class="check-option-content">
                            <div class="check-option-title">証跡書類整合性</div>
                            <div class="check-option-desc">
                                必須書類の不足、ファイル実体との不整合をチェック
                            </div>
                        </div>
                    </div>

                    <div class="check-option">
                        <input type="checkbox" id="dateConsistency">
                        <div class="check-option-content">
                            <div class="check-option-title">日付整合性</div>
                            <div class="check-option-desc">
                                送客日、承認日、報告日などの時系列整合性をチェック
                            </div>
                        </div>
                    </div>

                    <div class="check-option">
                        <input type="checkbox" id="duplicateCheck">
                        <div class="check-option-content">
                            <div class="check-option-title">重複データチェック</div>
                            <div class="check-option-desc">
                                重複送客、重複承認の検出と分析
                            </div>
                        </div>
                    </div>
                </div>

                <div class="check-actions">
                    <div class="check-info">
                        最終チェック: 2025-08-27 09:15 (24時間前)
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="selectAllChecks()">全選択</button>
                        <button class="btn btn-primary" onclick="runIntegrityCheck()">チェック実行</button>
                    </div>
                </div>
            </div>

            <!-- 進捗表示（チェック実行時のみ表示） -->
            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-header">
                    <div class="progress-title">データ整合性チェック進行中...</div>
                    <div class="progress-status" id="progressStatus">初期化中...</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                </div>
                <div class="log-container" id="logContainer">
                    <!-- ログがここに動的に追加される -->
                </div>
            </div>

            <!-- チェック結果サマリー -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number error">7</div>
                    <div class="stat-label">重大な問題</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number warning">15</div>
                    <div class="stat-label">警告</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number success">1,247</div>
                    <div class="stat-label">整合性OK</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">98.3%</div>
                    <div class="stat-label">整合性率</div>
                </div>
            </div>

            <!-- アラート -->
            <div class="alert alert-danger">
                🚨 7件の重大な整合性問題が検出されました。至急対応が必要です。
            </div>

            <!-- タブナビゲーション -->
            <div class="tab-container">
                <div class="tab-nav">
                    <button class="tab-button active" onclick="switchTab('critical')">重大な問題 (7)</button>
                    <button class="tab-button" onclick="switchTab('warnings')">警告 (15)</button>
                    <button class="tab-button" onclick="switchTab('resolved')">解決済み (23)</button>
                    <button class="tab-button" onclick="switchTab('history')">チェック履歴</button>
                </div>

                <!-- 重大な問題タブ -->
                <div id="critical-tab" class="tab-content active">
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">重大な整合性問題</h3>
                            <div class="action-buttons">
                                <button class="btn btn-danger btn-sm" onclick="fixCriticalIssues()">一括修正</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportCriticalReport()">詳細レポート</button>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>送客ID</th>
                                    <th>問題カテゴリ</th>
                                    <th>重要度</th>
                                    <th>問題詳細</th>
                                    <th>検出日時</th>
                                    <th>影響範囲</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="error">
                                    <td style="font-weight: 600;">REF-001</td>
                                    <td><span class="category-badge category-status">ステータス</span></td>
                                    <td><span class="severity-badge severity-critical">重大</span></td>
                                    <td class="issue-description" title="current_status_id=9（成約）だが、最新の承認済みステータスは7（見積提出）。月次報告で成約が承認されていない可能性。">
                                        ステータス不整合：成約報告が未承認
                                    </td>
                                    <td>
                                        <div>2025-08-28</div>
                                        <div style="font-size: 11px; color: #7a7a7a;">10:30</div>
                                    </td>
                                    <td>月次報告・手数料計算</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="viewIssueDetail('REF-001', 'status')">詳細</button>
                                            <button class="btn btn-danger btn-sm" onclick="fixIssue('REF-001')">修正</button>
                                        </div>
                                    </td>
                                </tr>

                                <tr class="error">
                                    <td style="font-weight: 600;">REF-015</td>
                                    <td><span class="category-badge category-amount">金額</span></td>
                                    <td><span class="severity-badge severity-critical">重大</span></td>
                                    <td class="issue-description" title="reported_status_id=9（成約）だが、contract_amount がNULL。成約時は契約金額の入力が必須。">
                                        成約時契約金額未入力
                                    </td>
                                    <td>
                                        <div>2025-08-28</div>
                                        <div style="font-size: 11px; color: #7a7a7a;">10:30</div>
                                    </td>
                                    <td>手数料計算・売上計上</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="viewIssueDetail('REF-015', 'amount')">詳細</button>
                                            <button class="btn btn-danger btn-sm" onclick="fixIssue('REF-015')">修正</button>
                                        </div>
                                    </td>
                                </tr>

                                <tr class="error">
                                    <td style="font-weight: 600;">REF-008</td>
                                    <td><span class="category-badge category-approval">承認</span></td>
                                    <td><span class="severity-badge severity-high">高</span></td>
                                    <td class="issue-description" title="monthly_referral_approvals テーブルに承認レコードが存在するが、対応するmonthly_referral_reportsレコードが削除されている。">
                                        孤立した承認レコード
                                    </td>
                                    <td>
                                        <div>2025-08-28</div>
                                        <div style="font-size: 11px; color: #7a7a7a;">10:30</div>
                                    </td>
                                    <td>データ整合性</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="viewIssueDetail('REF-008', 'approval')">詳細</button>
                                            <button class="btn btn-danger btn-sm" onclick="fixIssue('REF-008')">修正</button>
                                        </div>
                                    </td>
                                </tr>

                                <tr class="error">
                                    <td style="font-weight: 600;">REF-022</td>
                                    <td><span class="category-badge category-document">書類</span></td>
                                    <td><span class="severity-badge severity-high">高</span></td>
                                    <td class="issue-description" title="成約済み案件だが、誓約書（pledge_document）の提出記録が存在しない。成約時は誓約書提出が必須。">
                                        成約時必須書類未提出
                                    </td>
                                    <td>
                                        <div>2025-08-28</div>
                                        <div style="font-size: 11px; color: #7a7a7a;">10:30</div>
                                    </td>
                                    <td>コンプライアンス</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="viewIssueDetail('REF-022', 'document')">詳細</button>
                                            <button class="btn btn-danger btn-sm" onclick="fixIssue('REF-022')">修正</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 警告タブ -->
                <div id="warnings-tab" class="tab-content">
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">警告レベルの問題</h3>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="reviewWarnings()">一括レビュー</button>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>送客ID</th>
                                    <th>問題カテゴリ</th>
                                    <th>重要度</th>
                                    <th>問題詳細</th>
                                    <th>検出日時</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="warning">
                                    <td style="font-weight: 600;">REF-032</td>
                                    <td><span class="category-badge category-amount">金額</span></td>
                                    <td><span class="severity-badge severity-medium">中</span></td>
                                    <td class="issue-description" title="契約金額が1億円を超えています。通常の住宅案件としては高額のため確認が必要。">
                                        契約金額が異常に高額
                                    </td>
                                    <td>
                                        <div>2025-08-28</div>
                                        <div style="font-size: 11px; color: #7a7a7a;">10:30</div>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="viewWarningDetail('REF-032')">詳細</button>
                                            <button class="btn btn-secondary btn-sm" onclick="approveWarning('REF-032')">承認</button>
                                        </div>
                                    </td>
                                </tr>

                                <tr class="warning">
                                    <td style="font-weight: 600;">REF-045</td>
                                    <td><span class="category-badge category-status">ステータス</span></td>
                                    <td><span class="severity-badge severity-low">低</span></td>
                                    <td class="issue-description" title="送客から成約まで1日しか経っていません。通常より極端に短い期間のため確認をお勧めします。">
                                        成約までの期間が異常に短い
                                    </td>
                                    <td>
                                        <div>2025-08-28</div>
                                        <div style="font-size: 11px; color: #7a7a7a;">10:30</div>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="viewWarningDetail('REF-045')">詳細</button>
                                            <button class="btn btn-secondary btn-sm" onclick="approveWarning('REF-045')">承認</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 解決済みタブ -->
                <div id="resolved-tab" class="tab-content">
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">解決済み問題</h3>
                            <span style="font-size: 14px; color: #7a7a7a;">過去30日間に解決された問題</span>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>送客ID</th>
                                    <th>問題種別</th>
                                    <th>解決日</th>
                                    <th>解決方法</th>
                                    <th>担当者</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="font-weight: 600;">REF-020</td>
                                    <td>ステータス不整合</td>
                                    <td>2025-08-25</td>
                                    <td>手動ステータス修正</td>
                                    <td>田中管理者</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 600;">REF-018</td>
                                    <td>契約金額未入力</td>
                                    <td>2025-08-23</td>
                                    <td>企業への修正要求</td>
                                    <td>山田管理者</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- チェック履歴タブ -->
                <div id="history-tab" class="tab-content">
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">整合性チェック履歴</h3>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>実行日時</th>
                                    <th>チェック種別</th>
                                    <th>検出問題数</th>
                                    <th>処理時間</th>
                                    <th>実行者</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2025-08-28 10:30</td>
                                    <td>全項目チェック</td>
                                    <td>重大:7件 警告:15件</td>
                                    <td>2分35秒</td>
                                    <td>田中 太郎</td>
                                    <td>
                                        <button class="btn btn-secondary btn-sm" onclick="viewCheckDetail('20250828-1030')">詳細</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>2025-08-27 09:15</td>
                                    <td>ステータス整合性</td>
                                    <td>重大:3件 警告:8件</td>
                                    <td>45秒</td>
                                    <td>自動実行</td>
                                    <td>
                                        <button class="btn btn-secondary btn-sm" onclick="viewCheckDetail('20250827-0915')">詳細</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 問題詳細モーダル -->
    <div id="issueDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">整合性問題詳細</h3>
                <button class="close" onclick="closeModal('issueDetailModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">送客ID</label>
                    <input type="text" class="form-input" id="issueReferralId" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">問題カテゴリ</label>
                    <input type="text" class="form-input" id="issueCategory" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">詳細説明</label>
                    <textarea class="form-textarea" id="issueDescription" readonly></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">現在のデータ状態</label>
                    <textarea class="form-textarea" id="issueCurrentState" readonly></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">推奨修正方法</label>
                    <textarea class="form-textarea" id="issueRecommendation" readonly></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('issueDetailModal')">閉じる</button>
                <button class="btn btn-danger" onclick="executeAutoFix()">自動修正実行</button>
                <button class="btn btn-primary" onclick="createManualFixTask()">手動修正タスク作成</button>
            </div>
        </div>
    </div>

    <script>
        // 整合性チェック実行
        function runIntegrityCheck() {
            const checkboxes = document.querySelectorAll('.check-option input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('チェック項目を選択してください。');
                return;
            }

            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressStatus = document.getElementById('progressStatus');
            const logContainer = document.getElementById('logContainer');

            // プログレス表示開始
            progressContainer.style.display = 'block';
            logContainer.innerHTML = '';
            
            // チェック実行をシミュレート
            let progress = 0;
            const steps = Array.from(checkboxes).map(cb => cb.id);
            const interval = setInterval(() => {
                progress += 100 / steps.length;
                progressFill.style.width = Math.min(progress, 100) + '%';
                progressFill.textContent = Math.min(Math.round(progress), 100) + '%';
                
                if (progress <= 100) {
                    const currentStep = steps[Math.floor((progress - 1) / (100 / steps.length))];
                    progressStatus.textContent = `${getStepName(currentStep)}をチェック中...`;
                    addLogLine(`[${new Date().toLocaleTimeString()}] ${getStepName(currentStep)}の検証を開始`, 'info');
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    progressStatus.textContent = 'チェック完了';
                    addLogLine(`[${new Date().toLocaleTimeString()}] すべての整合性チェックが完了しました`, 'info');
                    addLogLine(`[${new Date().toLocaleTimeString()}] 重大な問題: 7件, 警告: 15件`, 'warning');
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        location.reload(); // 結果を更新表示
                    }, 2000);
                }
            }, 500);
        }

        function getStepName(stepId) {
            const names = {
                'statusConsistency': 'ステータス整合性',
                'approvalConsistency': '承認データ整合性',
                'amountValidation': '金額データ妥当性',
                'documentIntegrity': '証跡書類整合性',
                'dateConsistency': '日付整合性',
                'duplicateCheck': '重複データ'
            };
            return names[stepId] || stepId;
        }

        function addLogLine(message, type) {
            const logContainer = document.getElementById('logContainer');
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            line.textContent = message;
            logContainer.appendChild(line);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 全選択
        function selectAllChecks() {
            const checkboxes = document.querySelectorAll('.check-option input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }

        // タブ切り替え
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // 問題詳細表示
        function viewIssueDetail(referralId, category) {
            document.getElementById('issueReferralId').value = referralId;
            document.getElementById('issueCategory').value = category;
            
            // サンプルデータ設定
            if (category === 'status') {
                document.getElementById('issueDescription').value = 'customer_referrals.current_status_id=9（成約）だが、最新の承認済みステータスは7（見積提出）です。月次報告で成約が承認されていない可能性があります。';
                document.getElementById('issueCurrentState').value = 'current_status_id: 9\n最新承認済みステータス: 7\n最終承認日: 2025-08-20';
                document.getElementById('issueRecommendation').value = '1. 月次報告履歴を確認\n2. 成約報告が正しく承認されているか確認\n3. 必要に応じて手動でステータスを修正';
            }
            
            document.getElementById('issueDetailModal').classList.add('show');
        }

        // 問題修正
        function fixIssue(referralId) {
            if (confirm(`${referralId}の問題を修正しますか？\n自動修正が適用されます。`)) {
                alert('自動修正を実行しました。結果をログで確認してください。');
            }
        }

        // 自動修正実行
        function executeAutoFix() {
            if (confirm('自動修正を実行しますか？\nデータが変更される可能性があります。')) {
                alert('自動修正を実行しました。');
                closeModal('issueDetailModal');
            }
        }

        // 手動修正タスク作成
        function createManualFixTask() {
            alert('手動修正タスクを作成しました。\n担当者に通知されます。');
            closeModal('issueDetailModal');
        }

        // 重大問題の一括修正
        function fixCriticalIssues() {
            if (confirm('重大な問題を一括で自動修正しますか？\n修正不可能な問題は手動修正タスクとして作成されます。')) {
                alert('一括修正を開始しました。\n進捗は別途通知されます。');
            }
        }

        // 警告のレビュー
        function reviewWarnings() {
            alert('警告レベルの問題を一括レビュー画面で開きます。');
        }

        // 警告詳細
        function viewWarningDetail(referralId) {
            alert(`${referralId}の警告詳細を表示します。`);
        }

        // 警告承認
        function approveWarning(referralId) {
            if (confirm(`${referralId}の警告を承認しますか？\n今後このタイプの警告は表示されなくなります。`)) {
                alert('警告を承認しました。');
            }
        }

        // 自動チェック設定
        function scheduleAutomaticCheck() {
            alert('自動チェックスケジュール設定画面を開きます。\n- 毎日AM9:00実行\n- 問題検出時はメール通知\n- 重大問題は即座に通知');
        }

        // チェック詳細
        function viewCheckDetail(checkId) {
            alert(`チェック${checkId}の詳細結果を表示します。`);
        }

        // レポート出力
        function exportCriticalReport() {
            alert('重大問題の詳細レポートを出力します。\n- 問題一覧\n- 修正手順\n- 影響範囲分析');
        }

        // モーダル操作
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // モーダル外クリックで閉じる
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }
    </script>
</body>
</html>
// 不動産ポータルサイト テーブル構造（修正版）

// 【基本データ管理】

// 【企業マスターテーブル】不動産会社の基本情報を管理
companies {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  company_name // VARCHAR(255) NOT NULL 企業名
  company_code // VARCHAR(50) UNIQUE 企業コード
  postal_code // VARCHAR(8) 郵便番号
  address // TEXT 住所
  phone // VARCHAR(20) 電話番号
  email // VARCHAR(255) メールアドレス
  contact_person // VARCHAR(100) 担当者名
  status // ENUM('active', 'inactive', 'suspended') DEFAULT 'active' ステータス
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
}

// 【資料請求テーブル】顧客からの資料請求を記録・管理
document_requests {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  company_id > companies.id // BIGINT UNSIGNED NOT NULL FK 企業ID
  customer_name // VARCHAR(100) NOT NULL 顧客名
  customer_email // VARCHAR(255) NOT NULL 顧客メールアドレス
  customer_phone // VARCHAR(20) 顧客電話番号
  property_type // ENUM('mansion', 'house', 'land', 'investment', 'commercial') 物件種別
  budget_range // VARCHAR(50) 予算帯
  area_preference // VARCHAR(100) 希望エリア
  document_type // VARCHAR(100) NOT NULL 資料種別
  requested_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP 請求日時
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
}

// 【イベント予約テーブル】展示会・セミナー等のイベント予約を管理
event_reservations {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  company_id > companies.id // BIGINT UNSIGNED NOT NULL FK 企業ID
  event_name // VARCHAR(255) NOT NULL イベント名
  event_date // DATE NOT NULL イベント開催日
  event_time // TIME イベント開始時刻
  customer_name // VARCHAR(100) NOT NULL 顧客名
  customer_email // VARCHAR(255) NOT NULL 顧客メールアドレス
  customer_phone // VARCHAR(20) 顧客電話番号
  participant_count // INT DEFAULT 1 参加予定人数
  property_interest // ENUM('mansion', 'house', 'land', 'investment', 'commercial') 関心物件種別
  reserved_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP 予約日時
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
}

// 【物件見学予約テーブル】モデルハウス・物件見学の予約を管理
property_visit_reservations {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  company_id > companies.id // BIGINT UNSIGNED NOT NULL FK 企業ID
  property_name // VARCHAR(255) NOT NULL 物件名
  property_address // TEXT 物件住所
  visit_date // DATE NOT NULL 見学希望日
  visit_time // TIME 見学希望時刻
  customer_name // VARCHAR(100) NOT NULL 顧客名
  customer_email // VARCHAR(255) NOT NULL 顧客メールアドレス
  customer_phone // VARCHAR(20) 顧客電話番号
  visitor_count // INT DEFAULT 1 見学者数
  visit_purpose // TEXT 見学目的
  requested_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP 予約申込日時
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
}

// 【送客・ステータス管理】

// 【送客管理テーブル】企業への顧客送客情報と現在の進捗状況を管理
customer_referrals {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  company_id > companies.id // BIGINT UNSIGNED NOT NULL FK 企業ID
  customer_name // VARCHAR(100) NOT NULL 顧客名
  customer_email // VARCHAR(255) NOT NULL 顧客メールアドレス
  customer_phone // VARCHAR(20) 顧客電話番号
  is_first_referral // BOOLEAN DEFAULT FALSE 初回送客フラグ（企業が判定・設定）
  current_status_id > customer_status_types.id // BIGINT UNSIGNED NOT NULL FK 現在のステータスID
  referred_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP 送客日時
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  INDEX idx_company_customer_email (company_id, customer_email) // 送客履歴検索用
  INDEX idx_is_first_referral (is_first_referral) // 初回送客検索用
}

// 【顧客ステータスマスターテーブル】送客後の各進捗段階を定義・管理
customer_status_types {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  status_code // TINYINT NOT NULL UNIQUE ステータスコード
  status_name // VARCHAR(100) NOT NULL ステータス名
  display_order // TINYINT NOT NULL 表示順序
  is_active // BOOLEAN DEFAULT TRUE 有効フラグ
  description // TEXT ステータス説明
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
}

/* ステータスマスターデータ例:
1: 未対応
2: 資料送付済
3: 追客中
4: 来場日程調整中
5: 来場・商談中
6: 土地探し中
7: 概算見積り提示済
8: 詳細見積り提示済
9: 成約済
11: 他決
12: 検討停止
13: 営業停止
14: 不明
*/

// 【承認ステータスマスターテーブル】弊社承認プロセスのステータスを定義・管理
approval_status_types {
  id // TINYINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  status_code // TINYINT NOT NULL UNIQUE 承認ステータスコード（1:pending, 2:approved, 3:rejected, 4:revision_required）
  status_name // VARCHAR(100) NOT NULL 承認ステータス名
  display_order // TINYINT NOT NULL 表示順序
  is_active // BOOLEAN DEFAULT TRUE 有効フラグ
  description // TEXT 承認ステータス説明
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
}

// 【月次報告システム】

// 【月次報告テーブル】企業の月次報告提出管理
monthly_reports {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  company_id > companies.id // BIGINT UNSIGNED NOT NULL FK 企業ID
  report_year // YEAR NOT NULL 報告年
  report_month // TINYINT NOT NULL 報告月(1-12)
  total_referrals_reported // INT NOT NULL 報告送客数
  approval_status_id > approval_status_types.id // TINYINT UNSIGNED NOT NULL FK 承認ステータスID
  submitted_at // TIMESTAMP NULL 企業提出日時
  approved_at // TIMESTAMP NULL 承認日時
  approved_by // VARCHAR(100) 承認者
  rejection_reason // TEXT 却下理由
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  UNIQUE KEY unique_company_month (company_id, report_year, report_month) // 企業×月の重複防止
}

// 【月次報告承認テーブル】月次報告の承認プロセス管理
monthly_report_approvals {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  monthly_report_id > monthly_reports.id // BIGINT UNSIGNED NOT NULL FK 月次報告ID
  previous_status_id > approval_status_types.id // TINYINT UNSIGNED FK 変更前承認ステータス
  new_status_id > approval_status_types.id // TINYINT UNSIGNED NOT NULL FK 変更後承認ステータス
  changed_by // VARCHAR(100) NOT NULL 変更者
  change_reason // TEXT 変更理由・コメント
  changed_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP 変更日時
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
}

// 【月次送客報告テーブル】送客×月単位の中間テーブル（個別送客の月次進捗を管理）
monthly_referral_reports {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  monthly_report_id > monthly_reports.id // BIGINT UNSIGNED NOT NULL FK 月次報告ID
  referral_id > customer_referrals.id // BIGINT UNSIGNED NOT NULL FK 送客ID
  reported_status_id > customer_status_types.id // BIGINT UNSIGNED NOT NULL FK 報告時ステータスID
  contract_amount // DECIMAL(12,2) 契約金額
  expected_construction_date // DATE 着工予定日
  expected_completion_date // DATE 完成予定日
  progress_notes // TEXT 進捗メモ
  evidence_documents // JSON 証跡資料情報
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  UNIQUE KEY unique_report_referral (monthly_report_id, referral_id) // 月次報告×送客の重複防止
}

// 【実績管理】

// 【着工管理テーブル】成約後の着工・工事進捗を管理
construction_management {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  referral_id > customer_referrals.id // BIGINT UNSIGNED NOT NULL FK 送客ID（成約済みの送客のみ）
  contract_date // DATE NOT NULL 契約日
  contract_amount // DECIMAL(12,2) NOT NULL 契約金額
  property_address // TEXT 建築予定地・住所
  building_area // DECIMAL(10,2) 建築面積
  land_area // DECIMAL(10,2) 土地面積
  construction_status // ENUM('planned', 'started', 'in_progress', 'completed', 'suspended') DEFAULT 'planned' 工事ステータス
  planned_start_date // DATE 着工予定日
  actual_start_date // DATE 実際の着工日
  planned_completion_date // DATE 当初完成予定日
  actual_completion_date // DATE 実際の完成日
  contractor_name // VARCHAR(255) 施工業者名
  construction_permit_number // VARCHAR(100) 建築確認番号
  progress_percentage // TINYINT DEFAULT 0 工事進捗率(0-100)
  current_phase // VARCHAR(100) 現在の工事段階（基礎工事、上棟、内装工事等）
  inspection_status // VARCHAR(100) 検査状況
  quality_issues // TEXT 品質課題・問題点
  schedule_delay_days // SMALLINT DEFAULT 0 スケジュール遅延日数
  additional_costs // DECIMAL(10,2) DEFAULT 0 追加工事費用
  progress_notes // TEXT 工事進捗メモ
  next_inspection_date // DATE 次回検査予定日
  estimated_completion_date // DATE 完成予定日（更新値）
  photos_uploaded // BOOLEAN DEFAULT FALSE 工事写真アップロード済みフラグ
  is_verified // BOOLEAN DEFAULT FALSE 弊社確認済みフラグ
  verified_at // TIMESTAMP NULL 弊社確認日時
  verified_by // VARCHAR(100) 確認者
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  INDEX idx_referral_id (referral_id)
  INDEX idx_construction_status (construction_status)
  INDEX idx_contract_date (contract_date)
  INDEX idx_actual_start_date (actual_start_date)
  INDEX idx_progress_percentage (progress_percentage)
  INDEX idx_is_verified (is_verified)
}

// 【メディアアップロードテーブル】工事写真・証跡資料のアップロード管理
media_uploads {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  referral_id > customer_referrals.id // BIGINT UNSIGNED FK 送客ID（関連する場合）
  monthly_referral_report_id > monthly_referral_reports.id // BIGINT UNSIGNED FK 月次送客報告ID（関連する場合）
  file_type // ENUM('pledge_document', 'construction_report', 'construction_photo', 'contract_document', 'progress_report', 'other') NOT NULL ファイル種別
  file_name // VARCHAR(255) NOT NULL ファイル名
  file_path // VARCHAR(500) NOT NULL ファイルパス
  file_size // BIGINT ファイルサイズ（バイト）
  mime_type // VARCHAR(100) MIMEタイプ
  upload_date // DATE アップロード日
  description // TEXT ファイル説明
  is_verified // BOOLEAN DEFAULT FALSE 弊社確認済みフラグ
  verified_at // TIMESTAMP NULL 確認日時
  verified_by // VARCHAR(100) 確認者
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
}

// 【関連付け管理】

// 【資料請求送客中間テーブル】資料請求から発生した送客の関連付けを管理
document_request_referrals {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  document_request_id > document_requests.id // BIGINT UNSIGNED NOT NULL FK 資料請求ID
  referral_id > customer_referrals.id // BIGINT UNSIGNED NOT NULL FK 送客ID
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
}

// 【イベント送客中間テーブル】イベント参加から発生した送客の関連付けを管理
event_referrals {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  event_reservation_id > event_reservations.id // BIGINT UNSIGNED NOT NULL FK イベント予約ID
  referral_id > customer_referrals.id // BIGINT UNSIGNED NOT NULL FK 送客ID
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
}

// 【見学送客中間テーブル】物件見学から発生した送客の関連付けを管理
property_visit_referrals {
  id // BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY
  property_visit_id > property_visit_reservations.id // BIGINT UNSIGNED NOT NULL FK 見学予約ID
  referral_id > customer_referrals.id // BIGINT UNSIGNED NOT NULL FK 送客ID
  created_at // TIMESTAMP DEFAULT CURRENT_TIMESTAMP
}

// 【テーブル構造の整理と運用フローとの整合性】
// 
// **基本データ管理**
// - companies, document_requests, event_reservations, property_visit_reservations
//
// **送客・ステータス管理**
// - customer_referrals, customer_status_types, approval_status_types
//
// **月次報告システム（運用フローに完全対応）**
// - monthly_reports（企業×月の報告提出管理）= 運用フローの「月次報告承認テーブル」
// - monthly_report_approvals（承認プロセス履歴管理）
// - monthly_referral_reports（送客×月の個別進捗管理）= 運用フローの詳細報告
//
// **実績管理**
// - construction_management（成約後の着工・工事進捗管理）
// - media_uploads（必須ファイル：誓約書・着工報告書、任意ファイル：工事写真等）
//
// **関連付け管理**
// - document_request_referrals, event_referrals, property_visit_referrals
//
// **運用フロー対応の主要修正点**
// 1. monthly_reports = 運用フローの「月次報告承認テーブル」として位置付け
// 2. 前回ステータスIDは前回のmonthly_referral_reportsから取得する設計
// 3. ステータス変更日フィールドは不要のため削除
// 4. media_uploadsから不要なconstruction_id FK削除、必須フラグも削除
// 5. file_typeにpledge_document（誓約書）、construction_report（着工報告書）を追加
// 6. monthly_report_approvalsで承認履歴管理（簡潔な履歴管理で十分）
//
// **必須ファイル管理の実装方式**
// - 成約時：media_uploads.file_type = 'pledge_document'（誓約書）
// - 着工時：media_uploads.file_type = 'construction_report'（着工報告書）
// - 必須判定：file_typeで判定、専用フラグは不要
//
// **前回ステータス取得ロジック**
// - 同一送客の前回月次報告のreported_status_idを取得
// - 初回報告時は送客管理の初期ステータス（1:未対応）を参照
# 注文住宅DB設計 - リファクタリング提案

## 現状分析結果

### 1. 全体構造の問題点

#### 1.1 命名規則の不統一
- **テーブル名**: `snake_case`と`複数形/単数形`が混在
  - `custom_build_home_company_recommends` (複数形)
  - `custom_build_home_company_detail` (単数形)
  - `custom_built_home_catalog_request` (built vs build)

#### 1.2 テーブル名の冗長性
- すべてのテーブルに`custom_build_home_`または`custom_built_home_`プレフィックスが付いており、冗長

#### 1.3 タイポ・スペルミス
- `evnet_id` → `event_id` (line 122)
- `sub_descritpion` → `sub_description` (line 187)
- `architecturals_id` → `architectural_id` (line 236)
- `client_voide` → `client_voice` (line 48)

### 2. データ正規化の問題

#### 2.1 重複データ構造
- イベント予約とモデルハウス見学予約で同じフィールドが重複
- 住所情報が複数テーブルで重複（非正規化）

#### 2.2 分離すべきエンティティ
- 顧客情報が各予約テーブルに埋め込まれている
- 住所情報が直接格納されている

### 3. データ型・制約の欠如
- 外部キー制約の明示的定義がない
- データ型（VARCHAR長、INT型など）の指定がない
- NOT NULL制約の指定がない
- デフォルト値の指定がない

## リファクタリング提案

### 1. 命名規則の統一

```sql
-- プレフィックスを短縮し、一貫性のある命名に変更
-- 旧: custom_build_home_* → 新: cbh_*

-- 例：
cbh_companies               -- 企業情報
cbh_company_details         -- 企業詳細
cbh_architectural_examples  -- 建築事例
cbh_model_houses           -- モデルハウス
cbh_events                 -- イベント
cbh_catalogs               -- カタログ
```

### 2. 共通マスタテーブルの追加

```sql
-- 顧客マスタテーブル（共通化）
CREATE TABLE customers (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    last_name VARCHAR(50) NOT NULL,
    first_name VARCHAR(50) NOT NULL,
    last_name_kana VARCHAR(50) NOT NULL,
    first_name_kana VARCHAR(50) NOT NULL,
    email VARCHAR(255) NOT NULL,
    phone_number VARCHAR(20),
    age TINYINT UNSIGNED,
    is_newsletter_subscribed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_email (email),
    INDEX idx_phone (phone_number)
);

-- 住所マスタテーブル（共通化）
CREATE TABLE addresses (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    addressable_type VARCHAR(50) NOT NULL, -- ポリモーフィック関連
    addressable_id BIGINT UNSIGNED NOT NULL,
    type ENUM('current', 'construction_site', 'office') DEFAULT 'current',
    postal_code VARCHAR(8),
    prefecture_id INT UNSIGNED NOT NULL,
    city VARCHAR(100) NOT NULL,
    address_line VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_addressable (addressable_type, addressable_id),
    INDEX idx_postal_code (postal_code)
);

-- 都道府県マスタ
CREATE TABLE prefectures (
    id INT UNSIGNED PRIMARY KEY,
    name VARCHAR(10) NOT NULL,
    name_kana VARCHAR(20) NOT NULL,
    region VARCHAR(20) NOT NULL,
    sort_order INT UNSIGNED NOT NULL
);
```

### 3. リファクタリング後の主要テーブル

```sql
-- 企業情報（改善版）
CREATE TABLE cbh_companies (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_kana VARCHAR(200) NOT NULL,
    service_category_id INT UNSIGNED NOT NULL,
    representative_last_name VARCHAR(50),
    representative_first_name VARCHAR(50),
    phone_number VARCHAR(20),
    email VARCHAR(255),
    invoice_status_id INT UNSIGNED,
    invoice_number VARCHAR(50),
    invoice_scheduled_date DATE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    FOREIGN KEY (service_category_id) REFERENCES property_service_types(id),
    INDEX idx_active (is_active),
    INDEX idx_name (name),
    INDEX idx_deleted (deleted_at)
);

-- 企業詳細（改善版）
CREATE TABLE cbh_company_details (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    company_id BIGINT UNSIGNED NOT NULL UNIQUE,
    min_reference_price INT UNSIGNED,
    max_reference_price INT UNSIGNED,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (company_id) REFERENCES cbh_companies(id) ON DELETE CASCADE,
    CHECK (min_reference_price <= max_reference_price)
);

-- 建築事例（改善版）
CREATE TABLE cbh_architectural_examples (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    company_id BIGINT UNSIGNED NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    price INT UNSIGNED,
    total_floor_area DECIMAL(10,2),
    family_structure VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (company_id) REFERENCES cbh_companies(id) ON DELETE CASCADE,
    INDEX idx_company (company_id),
    INDEX idx_price (price)
);

-- 予約基本情報（共通化）
CREATE TABLE cbh_reservations (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    reservation_type ENUM('catalog', 'event', 'model_house') NOT NULL,
    customer_id BIGINT UNSIGNED NOT NULL,
    target_id BIGINT UNSIGNED NOT NULL, -- catalog_id, event_id, model_house_id
    preferred_date DATE,
    preferred_time TIME,
    preferred_contact_time VARCHAR(50),
    question_text TEXT,
    scheduled_construction_period VARCHAR(50),
    construction_budget VARCHAR(50),
    construction_details TEXT,
    current_situation TEXT,
    status ENUM('pending', 'confirmed', 'cancelled') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    INDEX idx_customer (customer_id),
    INDEX idx_type_target (reservation_type, target_id),
    INDEX idx_status (status),
    INDEX idx_date (preferred_date)
);
```

### 4. インデックス設計の改善

```sql
-- 検索性能向上のための複合インデックス
ALTER TABLE cbh_architectural_examples 
    ADD INDEX idx_company_price (company_id, price);

ALTER TABLE cbh_model_houses
    ADD INDEX idx_company_active (company_id, is_active),
    ADD INDEX idx_prefecture_active (prefecture_id, is_active);

ALTER TABLE cbh_events
    ADD INDEX idx_company_dates (company_id, start_date, end_date),
    ADD INDEX idx_active_dates (is_active, start_date, end_date);
```

### 5. ビューの活用

```sql
-- アクティブな企業の詳細情報ビュー
CREATE VIEW v_active_companies AS
SELECT 
    c.id,
    c.name,
    c.name_kana,
    cd.min_reference_price,
    cd.max_reference_price,
    cd.title,
    cd.description,
    COUNT(DISTINCT ae.id) as example_count,
    COUNT(DISTINCT mh.id) as model_house_count
FROM cbh_companies c
LEFT JOIN cbh_company_details cd ON c.id = cd.company_id
LEFT JOIN cbh_architectural_examples ae ON c.id = ae.company_id
LEFT JOIN cbh_model_houses mh ON c.id = mh.company_id AND mh.is_active = 1
WHERE c.is_active = 1 AND c.deleted_at IS NULL
GROUP BY c.id;
```

### 6. トリガーによるデータ整合性

```sql
-- 予約時に顧客情報を自動作成
DELIMITER //
CREATE TRIGGER before_reservation_insert
BEFORE INSERT ON cbh_reservations
FOR EACH ROW
BEGIN
    IF NEW.customer_id IS NULL THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'Customer ID cannot be null';
    END IF;
END//
DELIMITER ;
```

### 7. パフォーマンス最適化

```sql
-- パーティショニング（大量データ対応）
ALTER TABLE cbh_reservations
PARTITION BY RANGE (YEAR(created_at)) (
    PARTITION p2023 VALUES LESS THAN (2024),
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

## 移行戦略

### Phase 1: 準備（1-2週間）
1. 新規テーブル構造の作成
2. データ移行スクリプトの作成
3. テスト環境での検証

### Phase 2: 段階的移行（2-4週間）
1. 共通マスタテーブルの導入
2. 既存データの移行
3. アプリケーション層の段階的更新

### Phase 3: 最適化（1-2週間）
1. インデックスの追加
2. ビューの作成
3. パフォーマンステスト

### Phase 4: 切り替え（1日）
1. 本番環境への適用
2. 旧テーブルの無効化
3. モニタリング

## メリット

1. **保守性向上**: 命名規則の統一により理解しやすい
2. **パフォーマンス改善**: 適切なインデックスにより検索速度向上
3. **データ整合性**: 外部キー制約により不整合を防止
4. **拡張性**: 共通化により新機能追加が容易
5. **運用効率**: ビューにより複雑なクエリを簡素化

## 注意事項

- アプリケーション層の大幅な修正が必要
- 移行期間中の並行稼働の考慮
- バックアップとロールバック計画の策定
- ステークホルダーへの影響範囲の説明